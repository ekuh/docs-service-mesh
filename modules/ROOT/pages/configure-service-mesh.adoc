= Configure Service Mesh
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]
:keywords: service mesh, microservices, downloading, installing

image::configure-service-mesh-breadcrumb.png[]


[[adapter-overview]]
== Service Mesh Adapter Overview

To configure Service Mesh, you must provision the Service Mesh adapter and bind it with a specific namespace. Each adapters is bound to a specific namespace. Therefore, a namespace can be associated with only one adapter at any given time. 

When you provision the adapter, you must specify the size of the adapter based on the number of CPUs and memory of the system that will be managed in Service Mesh.

You configure Service Mesh using the following three steps:

. <<provision-adapter,Provision Service Mesh Adapter>>
. <<create-non-mule-app,Create an API>>
. <<bind-adapter,Bind your service>>

=== Adapter Plan
Anypoint Service Mesh currently supports three plans for the adapter:

[%header%autowidth.spread]
|===
| Plan | CPU (cores) | Memory (GiB) | API Limit
| small | .5 | 1 | 25
| medium | 1 | 1.5 | 50
| large | 2 | 2 | 100
|===

You can also modify the size of an adapter after it has been provisioned. If you update the plan to change the plan size or any other parameter, the adapter deployment is updated appropriately. Kubernetes then creates a pod with new information. However, the old adapter continues handling requests until the new pod is ready.

After the new adapter is ready, the old pod is terminated and all requests are routed to the new adapter. If the update fails due to insufficient space  to start up a new pod, or if the pod is not ready, an error message is recorded in Kubernetes event. In such a scenario, the old adapter continues to handle requests because the new pod is not yet available. 

=== Adapter Status

When you provision an adapter, or bind the adapter to an application, a message is displayed after you run an adapter command. The message indicates whether the adapter was created, deleted, or modified successfully. 

Additionally, you can verify the adapter status, which provides further details about the adapter. 

To view the adapter status, type the following command:

`./service-mesh adapter list`

The status values include:

* Ready--The adapter is now ready to be used. 
* Failed--The adapter was not created successfully. An error occurred. 
* Provisioning--The adapter is in the process of being provisioned.

=== CLI Help for Adapter Commands

The command line interface (CLI) tool for Service Mesh provides help for various commands. You can issue help commands at any time after you complete installing Service Mesh. 

To use the help, type the following command:
`./service-mesh help`

image::service-mesh-cli-adapter-help.png[CLI Help for Adapter Commands]


[[provision-adapter]]
== Provision Service Mesh Adapter

Before	you can start managing your API using Service Mesh, you must prepare your namespace by provisioning a Service Mesh Adapter. Provisioning prepares the namespace for the Service Mesh configuration. 

After you provision the adapter, you must redeploy your existing application to ensure that the Envoy sidecar is injected with each pod.

To provision the Anypoint Service Mesh adapter:
 
. Determine the adapter size based on the plan.
. From the Service Mesh installer download location in the Command window, type the following command to create the adapter:
+
[source,text,linenums]
----
./service-mesh adapter create \
--name=<adapter name> \
--namespace=<adapter namespace> \
--size=<adapter plan size> \
--clientId=<clientId of the environment or organization> \
--clientSecret=<clientSecret of the environment or organization> \
--platformUri=<URL of Anypoint Platform>
----
+
[%header%autowidth.spread]
|===
| Parameter Name | Description | Required/Optional | Default Value
| `name` | The name of the adapter that you want to create, for example, “service-mesh-test-adapter”. | Required | N/A
| `namespace` | The namespace in which you want to create the adapter, for example, “mulesoft-apps”. | Optional | default
| `size`| The size of the adapter based on the number of CPUs and memory to use | Optional | medium
| `clientId` | The client ID of the environment (recommended) or the organization. Use the client ID that you obtained as part of the permission and roles prerequisites as explained in this document. | Required | N/A
| `clientSecret` | The client secret of the environment (recommended) or the organization. Use the client secret that you obtained as part of the permission and roles prerequisites as explained in this document.| Required | N/A
| `platformUri` | The URL of the host where Anypoint Platform is installed | Optional | https://anypoint.mulesoft.com
|===
+
. Verify the adapter status using the `list` command.
+
image::provision-service-mesh-adapter-output.png[Example Output]
+
. Review adapter logs to see detailed information about Kubernetes events and adapter transactions:
+
`./service-mesh adapter logs --name=<adapter_name> --namespace=<namespace>`
. Optionally, if your applications were already running in the namespace before starting the Service Mesh installation, restart your application to inject the sidecar in the pod:
+
`kubectl -n <namespace> patch deploy <deployname> --type=json -p='[{"op": "replace", "path": "/spec/template/metadata/labels/service-mesh.mulesoft.com","value":"enable"}]'`
+
In the above command, replace the namespace and the deploy name with your specific details.

[[create-non-mule-app]]
== Create an API in Anypoint Platform

After you provision the adapter, you must create an API to bind to the service. 

To create an API, perform the following steps:

. Go to *Anypoint Platform > API Manager* and select the *Manage API* drop-down list. 
. Select *Create new API*.
+
The Creating an asset page is displayed.
. Specify the *Name*, *Asset types* details for the API.  
+
The Endpoint Configuration window is displayed, as shown in the following screenshot.
+
image::create-non-mule-api-service-mesh.png[85%, 85%]
+
. In the *Managing type* field, select the *Basic Endpoint* radio button.
. In the *Application type* field, select the *Non-Mule application* radio button.
. Optionally, specify the *Implementation URI*, and click *Save*.
+
Your API is now created.

[[bind-adapter]]
== Bind your service to an API 

You are now ready to bind the API that you created previously to the service. The adapter uses the unique API ID of the API for this binding. Anypoint Platform uses the API ID to fetch policies and apply them to your services that are running in the cluster.

After the binding is completed, you can view the status using the `list` command. The status values include:

* Ready--The binding is now ready to be used. 
* Failed--The binding was not created successfully. An error occurred. 
* Binding--The binding is in the process of being associated with specific application.

In the following example, a binding called “customers” is created to bind the “anypoint-service-mesh-adapter” adapter with the "customers" service. This binding is created in the “nto-payments” namespace, which is the same namespace where the adapter was previously created, and is associated with the API that has the ID as 1234.

[source,text,linenums]
----
NAMESPACE      NAME        ADAPTER                         API ID  SERVICE NAME    STATUS
nto-payments   customers   anypoint-service-mesh-adapter   1234    customers       Ready
----

To bind the service with an API, perform the following steps:

. Go to *Anypoint Platform > API administration*, and expand the API version name to display the instances.
. Click an instance name and copy the API ID that is displayed. 
+
image::api-id.png[]
. Verify that the application Kubernetes service port is named following the requirements requested by Istio. 
For more information, see the Istio documentation.
. From the Service Mesh installer download location in the Command window, type the following command to bind the adapter with an application:
+
[source,text,linenums]
----
./service-mesh binding create \
--name=<servicename> \
--namespace=<namespace name> \
--adapter=<adapter name> \
--apiId=<api ID> \
--serviceName=<servicename>
----
+
[%header%autowidth.spread]
|===
| Parameter Name | Description | Required/Optional | Default Value
| name | The name that identifies the binding that you want to create, for example, service-binding-anypoint-security”. 
 | Required | N/A
| namespace | The namespace in which your service is deployed. Make sure that you use the same namespace as the adapter you provisioned in the previous procedure. | Required | N/A
| adapter | Specify the name of the adapter that you provisioned in the previous procedure.  | Required | N/A 
| apiId | Specify the API ID of the API that you want to associate with this adapter. Use the API ID you obtained as part of Review Prerequisites section of this document. | Required | N/A.
| serviceName | The name of the service to be bound to the API, which will be managed by Anypoint Platform. | Required | N/A.
|===
+
The binding becomes activate within a few seconds and the API is successfully registered to the proxy.
. Verify the binding status using the following command:
+
`./service-mesh binding list`

After you bind your API, the API in API Manager is marked as Active. You are now ready to apply policies to protect your APIs.

image::api-manager-status-for-service-mesh.png[85%, 85%]

== See Also

* xref:api-manager::find-api-id-task.adoc[Obtain API ID]
* https://istio.io/docs/setup/additional-setup/requirements/[Istio Documentation]




