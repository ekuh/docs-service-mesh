= Troubleshoot API Provisioning Issues
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]
:keywords: service mesh, microservices, API provisioning issues, troubleshooting

After you provision an adapter, you must create an API, to which you then bind the service. This section provides possible causes for issues that might occur when try to create your API, and describes how to troubleshoot these errors:

* <<client-secret-incorrectly-configured,Client Secret is Incorrectly Configured>>
* <<provision-call-failed,Provision call failed>>

[[client-secret-incorrectly-configured]]
== Client Secret is Incorrectly Configured

If using a secret when you create an API, you must verify that you are correctly referencing the secret.

=== Cause

If you provide incorrect credentials, the following error occurs:

image::credentials-error-api-prov-service-mesh.png[Credentials error when provisioning APIs]

=== Diagnosis

To diagnose the issue:

. Describe your service instance using the `kubectl describe serviceinstance _api_instance_name_` command:
+
`$ kubectl describe serviceinstance inventory-resource-api`
In the `Status` field, a detailed description of the error is displayed:
+
image::error-with-params-error-display-api-prov-service-mesh.png[Error with parameters when provisioning APIs]

In the following example, an error occurred due to an extra comma in the stringData section that is provided after the password segment:

[source,text,linenums]
----
apiVersion: v1
kind: Secret
metadata:
  name: my-credentials
  namespace: nto-payment
type: Opaque
stringData:
  user-pass:
    '{
      "user": "<user>",
      "password": "<password>",
    }'
----

=== Solution

To resolve this issue:

. Delete the API.
. Resolve the username and password error.
. Re-create the API.  


[[provision-call-failed]]
== Provision call failed

When you create an API, the Asset(in exchange) and/or API(in API Manager) are not successfuly created on the Anypoint Platform

== Causes

This error can occur if:
 
* You are trying to re-create an asset on exchange after having deleted it more than seven days ago.
* You are trying to create an API with invalid values.


=== Diagnose

Confirm that you have the issue by running the following commands: `$ asmctl api list`. The status of the API displays as `ProvisionCallFailed`. 


Run `asmctl api logs --name=<replace_with_api_name> --namespace=<replace_with_namespace>`. The following output shows an exampe when trying to provision an API with an invalid version.

[source,text,linenums]
----
DATE                   MESSAGE
2020-05-29T17:12:36Z   Error provisioning ServiceInstance of ClusterServiceClass (K8S: "1c3b2100-5cdc-49ea-9423-dd7170e674b4" ExternalName: "anypoint-platform-api-instance") at ClusterServiceBroker "service-mesh-incluster-broker": Status: 400; ErrorMessage: Bad Request; Description: version: should match pattern "^\d+\.\d+\.\d+(-.+)?$" (ID: 49724b5d-7fad-4cc3-980e-695c2e47b383); ResponseError: <nil>
----

In case there is no information above, you will have to run `kubectl describe serviceinstances <replace_with_api_name> -n <replace_with_namespace>`. In the `status` section of the resource, you will find the error message explaining the issue. For example: 

[source,text,linenums]
----
Error provisioning ServiceInstance of ClusterServiceClass (K8S: "1c3b2100-5cdc-49ea-9423-dd7170e674b4"
ExternalName: "anypoint-platform-api-instance") at ClusterServiceBroker "service-mesh-incluster-broker": Status: 410; ErrorMessage: Gone; Description: Error from Exchange: There is no asset matching given parameters. (ID: 79d0cc7f-9969-477b-816d-c822916c0290); ResponseError: <nil>' reason: ProvisionCallFailed
----

In above case, the error has to do with the fact that you are trying to re-create an asset on exchange after having deleted it more than seven days ago. Exchange doesn't allow that operation, so you need to provide a new assetId to create a new asset.  


=== Solution

Delete your API by executing `asmctl api delete --name=<replace_with_api_name> --namespace=<replace_with_namespace>`. Recreate the API once you have fixed the error.
